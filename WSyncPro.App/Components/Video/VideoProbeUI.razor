@using WSyncPro.Core.Services.VideoProbing
@using WSyncPro.Models.Files
@inject IVideoProbeService VideoProbeService

<MudPaper Class="pa-4" Elevation="4">
    <MudText Typo="Typo.h5" GutterBottom="true">Probe Videos in Folder</MudText>

    <MudTextField @bind-Value="folderPath" Label="Folder Path" Variant="Variant.Outlined" FullWidth="true" />
    <MudButton OnClick="ProbeFolder" Color="Color.Primary" Variant="Variant.Filled" Class="mt-2">
        Probe Folder
    </MudButton>

    @if (isLoading)
    {
        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Class="mt-4" />
    }

    @if (probedResults?.Any() == true)
    {
        <MudTable Items="probedResults" Hover="true" Striped="true" Class="mt-4">
            <HeaderContent>
                <MudTh>File Name</MudTh>
                <MudTh>Size (bytes)</MudTh>
                <MudTh>Duration (s)</MudTh>
                <MudTh>Resolution</MudTh>
                <MudTh>Video Codec</MudTh>
                <MudTh>Audio Codec</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="File Name">@context.FileName</MudTd>
                <MudTd DataLabel="Size (bytes)">@context.FileSize</MudTd>
                <MudTd DataLabel="Duration (s)">@context.DurationSeconds</MudTd>
                <MudTd DataLabel="Resolution">@($"{context.Width} x {context.Height}")</MudTd>
                <MudTd DataLabel="Video Codec">@context.VideoCodec</MudTd>
                <MudTd DataLabel="Audio Codec">@context.AudioCodec</MudTd>
            </RowTemplate>
        </MudTable>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mt-4">@errorMessage</MudAlert>
    }
    </MudPaper>

    @code {
    private string folderPath = string.Empty;
    private bool isLoading = false;
    private List<FileInfoPayload> probedResults = new();
    private string? errorMessage;

    private async Task ProbeFolder()
    {
        errorMessage = null;
        probedResults.Clear();

        if (string.IsNullOrWhiteSpace(folderPath))
        {
            errorMessage = "Please enter a valid folder path.";
            return;
        }
        if (!Directory.Exists(folderPath))
        {
            errorMessage = "The specified folder does not exist.";
            return;
        }

        isLoading = true;
        try
        {
            // Run the probe service (which creates .metainf sidecar files)
            await VideoProbeService.RunInfoProbe(folderPath);

            // Read all metadata files generated by the probe service.
            var metaFiles = Directory.GetFiles(folderPath, "*.metainf", SearchOption.AllDirectories);
            foreach (var metaFile in metaFiles)
            {
                try
                {
                    var jsonContent = await File.ReadAllTextAsync(metaFile);
                    var payload = System.Text.Json.JsonSerializer.Deserialize<FileInfoPayload>(jsonContent);
                    if (payload != null)
                    {
                        probedResults.Add(payload);
                    }
                }
                catch (Exception ex)
                {
                    // Optionally log the error and continue with the next file.
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred while probing videos: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
