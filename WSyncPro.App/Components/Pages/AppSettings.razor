@page "/appsettings"
@using Microsoft.Extensions.Logging
@using WSyncPro.Models.Config
@using WSyncPro.Util.Files
@inject IFileLoader FileLoader
@inject ILogger<AppSettings> Logger

<h3>App Settings</h3>

<div>
    <label for="handbrakePath">Handbrake CLI Path:</label>
    <input id="handbrakePath" type="text" @bind="AppSettingsModel.HANDBREAK_CLI_PATH" placeholder="Enter Handbrake CLI Path" />
</div>

<div class="mt-3">
    <button class="btn btn-primary" @onclick="() => SaveSettings(SettingsPath)">Save Settings</button>
    <button class="btn btn-secondary ms-2" @onclick="() => LoadSettings(SettingsPath)">Load Settings</button>
</div>

@if (StatusMessage != null)
{
    <div class="alert alert-info mt-3">
        @StatusMessage
    </div>
}

@code {
    public AppSettingsModel AppSettingsModel = new AppSettingsModel();
    public string SettingsPath = "settings.json";
    public string? StatusMessage;

    private async Task SaveSettings(string filepath)
    {
        try
        {
            if (AppSettingsModel != null)
            {
                Logger.LogInformation("Attempting to save Settings");
                await FileLoader.SaveToFileAsObjectAsync(filepath, AppSettingsModel);
                StatusMessage = "Settings successfully saved.";
            }
        }
        catch (Exception e)
        {
            Logger.LogError(e, "Error saving settings to file.");
            StatusMessage = "Error saving settings. See logs for details.";
        }
    }

    private async Task LoadSettings(string filepath)
    {
        try
        {
            if (string.IsNullOrWhiteSpace(filepath))
            {
                Logger.LogWarning("Load file path is empty.");
                StatusMessage = "File path is empty.";
                return;
            }

            var tempSettings = await FileLoader.LoadFileAndParseAsync<AppSettingsModel>(filepath);
            if (tempSettings != null)
            {
                AppSettingsModel = tempSettings;
                StatusMessage = "Settings successfully loaded.";
            }
            else
            {
                StatusMessage = "No settings found in the file.";
            }

            Logger.LogInformation("Settings Loaded");
        }
        catch (Exception e)
        {
            Logger.LogError(e, "Error loading settings.");
            StatusMessage = "Error loading settings. See logs for details.";
        }
    }
}
