@page "/syncjob"
@using System.Text.Json
@using WSyncPro.Models.Content
@using WSyncPro.Core.Managers
@using WSyncPro.Util.Files
@inject IFileLoader FileLoader
@inject NavigationManager Navigation

<h3>SyncJob Management</h3>
<button @onclick="ShowRunSelectedJobsPopup" class="btn btn-primary">Run selected jobs</button>
<button @onclick="CreateNewJob" class="btn btn-secondary">Create New Job</button>

<div class="syncjob-table-container">
    <table class="syncjob-table">
        <thead>
            <tr>
                <th>Select</th>
                <th>Job Name</th>
                <th>Description</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var job in SyncJobs)
            {
                <tr>
                    <td><input type="checkbox" @bind="job.Selected" /></td>
                    <td><input type="text" @bind="job.Name" /></td>
                    <td><input type="text" @bind="job.Description" /></td>
                    <td>@StateManager.Instance.JobStates.TryGetValue(job, out var state) ? state.Status.ToString() : "Unknown"</td>
                    <td><button @onclick="() => EditJob(job)" class="btn btn-sm btn-info">Edit</button></td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Job Execution Progress Modal -->
@if (showRunJobsPopup)

{
    <div class="modal">
        <div class="modal-content">
            <h4>Running Jobs</h4>
            @foreach (var job in SyncJobs.Where(j => j.Selected))

            {
                <div>
                    <h5>@job.Name</h5>
                    <progress value="@GetJobProgress(job)" max="100"></progress>
                    <p>@StateManager.Instance.JobStates.TryGetValue(job, out var state) ? $"Processed {state.ItemsProcessed}/{state.TotalItemToProcess} items" : "Waiting"</p>
                </div>
            }
            <button @onclick="CloseRunJobsPopup" class="btn btn-danger">Close</button>
        </div>
    </div>
}

@code {
    private List<SyncJob> SyncJobs = new();

    private bool showRunJobsPopup;



    protected override async Task OnInitializedAsync()

    {

        // Load jobs from joblist.json in wwwroot

        var joblistPath = Path.Combine("wwwroot", "jobs", "joblist.json");

        try

        {

            var fileContent = await FileLoader.LoadFileAsStringAsync(joblistPath);

            SyncJobs = JsonSerializer.Deserialize<List<SyncJob>>(fileContent);

        }

        catch (Exception ex)

        {

            Console.WriteLine($"Error loading sync jobs: {ex.Message}");

        }

    }



    private void ShowRunSelectedJobsPopup()

    {

        showRunJobsPopup = true;

    }



    private void CloseRunJobsPopup()

    {

        showRunJobsPopup = false;

    }



    private void CreateNewJob()

    {

        var newJob = new SyncJob

            {

                Id = Guid.NewGuid(),

                Name = "New Job",

                Description = "New job description",

                Status = WSyncPro.Models.Enum.Status.Pending

            };

        SyncJobs.Add(newJob);

    }



    private void EditJob(SyncJob job)

    {

        // Open a separate edit page for the job (or implement an inline edit UI)

        Navigation.NavigateTo($"/editjob/{job.Id}");

    }



    private int GetJobProgress(SyncJob job)

    {

        if (StateManager.Instance.JobStates.TryGetValue(job, out var state))

        {

            return (int)((state.ItemsProcessed / (double)state.TotalItemToProcess) * 100);

        }

        return 0;

    }
}
