@page "/sync/edit/{JobId:guid}"
@using WSyncPro.Core.Services
@using WSyncPro.Models.Content
@inject ISyncService SyncService
@inject NavigationManager NavigationManager
@using Microsoft.Maui.Storage
@using System.IO

<h3>Edit Sync Job</h3>

<EditForm Model="@job" OnValidSubmit="SaveChanges">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label for="Name" class="form-label">Job Name</label>
        <InputText id="Name" class="form-control" @bind-Value="job.Name" />
    </div>

    <div class="mb-3">
        <label for="Description" class="form-label">Description</label>
        <InputText id="Description" class="form-control" @bind-Value="job.Description" />
    </div>

    <div class="mb-3">
        <label for="SrcDirectory" class="form-label">Source Directory</label>
        <InputText id="SrcDirectory" class="form-control" @bind-Value="job.SrcDirectory" />
        <button class="btn btn-secondary" type="button" @onclick="PickSourceDirectory">Pick Source Directory</button>
    </div>

    <div class="mb-3">
        <label for="DstDirectory" class="form-label">Destination Directory</label>
        <InputText id="DstDirectory" class="form-control" @bind-Value="job.DstDirectory" />
        <button class="btn btn-secondary" type="button" @onclick="PickDestinationDirectory">Pick Destination Directory</button>
    </div>

    <div class="mb-3">
        <label for="FilterInclude" class="form-label">Include Filters (one per line)</label>
        <textarea id="FilterInclude" class="form-control" rows="3" @bind="filterIncludeText"></textarea>
    </div>

    <div class="mb-3">
        <label for="FilterExclude" class="form-label">Exclude Filters (one per line)</label>
        <textarea id="FilterExclude" class="form-control" rows="3" @bind="filterExcludeText"></textarea>
    </div>

    <div class="mb-3">
        <label>Job Status</label>
        <InputRadioGroup @bind-Value="job.Enabled">
            <div>
                <InputRadio Value="true" /> Enabled
            </div>
            <div>
                <InputRadio Value="false" /> Disabled
            </div>
        </InputRadioGroup>
    </div>


    <button type="submit" class="btn btn-success">Save Changes</button>
    <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
</EditForm>

@code {
    [Parameter] public Guid JobId { get; set; }
    private SyncJob job;
    private string filterIncludeText = string.Empty;
    private string filterExcludeText = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        job = await SyncService.GetJobById(JobId);
        // Convert filter lists to text for editing
        filterIncludeText = string.Join(Environment.NewLine, job.FilterInclude ?? new List<string>());
        filterExcludeText = string.Join(Environment.NewLine, job.FilterExclude ?? new List<string>());
    }

    private async Task SaveChanges()
    {
        try
        {
            // Set the file path to a safe directory (AppDataDirectory)
            string filePath = Path.Combine(FileSystem.AppDataDirectory, "syncJobConfig.json");

            // Convert text back to lists
            job.FilterInclude = filterIncludeText.Split(Environment.NewLine).ToList();
            job.FilterExclude = filterExcludeText.Split(Environment.NewLine).ToList();

            await SyncService.AddJob(job);  // Update the job
            await SyncService.SaveJoblistToFile(filePath);  // Save changes
            NavigationManager.NavigateTo("/sync");
        }
        catch (UnauthorizedAccessException ex)
        {
            Console.WriteLine($"Error saving job: {ex.Message}");
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/sync");
    }

    private void PickSourceDirectory()
    {
        try
        {
            job.SrcDirectory = "/path/to/source"; // Placeholder: Implement picker logic
        }
        catch (UnauthorizedAccessException ex)
        {
            Console.WriteLine($"Error accessing source directory: {ex.Message}");
        }
    }

    private void PickDestinationDirectory()
    {
        try
        {
            job.DstDirectory = "/path/to/destination"; // Placeholder: Implement picker logic
        }
        catch (UnauthorizedAccessException ex)
        {
            Console.WriteLine($"Error accessing destination directory: {ex.Message}");
        }
    }
}
