@page "/render"
@using Microsoft.Extensions.Logging
@using WSyncPro.Core.Services
@using WSyncPro.Models.Config
@using WSyncPro.Models.Content
@using WSyncPro.Models.Data
@using WSyncPro.Models.Enum.ReRenderEnumCollection
@inject ILogger<ReRender> Logger
@inject IDirectoryScannerService Dss

<h3>ReRender Jobs</h3>

<div>
    <label for="jobName">Job Name:</label>
    <input id="jobName" type="text" @bind="RenderJob.Name" placeholder="Enter job name" class="form-control" />

    <label for="srcDirectory">Source Directory/File:</label>
    <input id="srcDirectory" type="text" @bind="RenderJob.SrcDirectory" placeholder="Enter source path" class="form-control" />

    <label for="dstDirectory">Destination Directory:</label>
    <input id="dstDirectory" type="text" @bind="RenderJob.DstDirectory" placeholder="Enter destination path" class="form-control" />

    <label for="videoType">Video Type:</label>
    <select id="videoType" @bind="RenderJob.VideoType" class="form-control">
        @foreach (var videoType in VideoType.All)
        {
            <option value="@videoType">@videoType.ToString()</option>
        }
    </select>

    <div class="form-check mt-3">
        <input type="checkbox" id="deleteOriginal" class="form-check-input" @bind="RenderJob.DeleteOriginal" />
        <label class="form-check-label" for="deleteOriginal">Delete Original Files</label>
    </div>
</div>

<div class="mt-3">
    <button class="btn btn-primary" @onclick="RunReRender" disabled="@RenderJob.IsRunning">Run ReRender</button>
    <button class="btn btn-secondary" @onclick="AnalyzeDirectory" disabled="@RenderJob.IsRunning">Analyze Directory</button>
</div>

@if (AnalyzedFiles != null && AnalyzedFiles.Any())
{
    <h4>Files to Process:</h4>
    <ul>
        @foreach (var file in AnalyzedFiles)
        {
            <li>@file</li>
        }
    </ul>
}

@if (IsProcessing)
{
    <div class="mt-3">
        <p><strong>ReRender in progress...</strong></p>
        <p>@StatusMessage</p>
        <progress value="@ProcessedFiles" max="@TotalFiles"></progress>
        <p>Processed @ProcessedFiles of @TotalFiles files</p>
    </div>
}

<div class="mt-3">
    <span class="text-success">@StatusMessage</span>
</div>

@code {
    private RenderJob RenderJob = new RenderJob();
    private string StatusMessage = string.Empty;
    private List<string> AnalyzedFiles = new();
    private int ProcessedFiles = 0;
    private int TotalFiles = 0;
    private bool IsProcessing = false;

    private async Task RunReRender()
    {
        try
        {
            RenderJob.IsRunning = true;
            IsProcessing = true;
            StatusMessage = "ReRender started...";
            Logger.LogInformation("ReRender started for job: {JobName}", RenderJob.Name);

            var reRenderService = new ReRenderService(Dss, new WEnv());
            reRenderService.ProgressChanged += OnProgressChanged;

            await reRenderService.ReRender(RenderJob);

            StatusMessage = "ReRender completed successfully!";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during ReRender execution.");
            StatusMessage = $"Error: {ex.Message}";
        }
        finally
        {
            RenderJob.IsRunning = false;
            IsProcessing = false;
        }
    }

    private async Task AnalyzeDirectory()
    {
        try
        {
            StatusMessage = "Analyzing directory...";
            Logger.LogInformation("Analyzing directory for job: {JobName}", RenderJob.Name);

            var objects = await Dss.ScanAsync(RenderJob);
            AnalyzedFiles = objects.OfType<WFile>().Select(w => w.FullPath).ToList();

            StatusMessage = $"Found {AnalyzedFiles.Count} files to process.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during directory analysis.");
            StatusMessage = $"Error: {ex.Message}";
        }
    }

    private void OnProgressChanged(object sender, ReRenderProgressEventArgs e)
    {
        ProcessedFiles = e.ProcessedFiles;
        TotalFiles = e.TotalFiles;
        StatusMessage = e.Message;

        InvokeAsync(StateHasChanged);
    }
}
