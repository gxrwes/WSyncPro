@page "/demo"
@using Blazored.LocalStorage
@using Blazored.Toast
@using Blazored.Toast.Services
@using Tewr.Blazor.FileReader
@using MudBlazor

@rendermode InteractiveServer
@inject IToastService ToastService
@inject ILocalStorageService LocalStorageService
@inject IFileReaderService FileReaderService

<h3>Demo</h3>

<MudTabs>
    <!-- File Table Example -->
    <MudTabPanel Text="File Table">
        <MudTable Items="@files" Dense="true">
            <HeaderContent>
                <MudTh>File Name</MudTh>
                <MudTh>Path</MudTh>
                <MudTh>Size (KB)</MudTh>
                <MudTh>Preview</MudTh>
            </HeaderContent>
            <RowTemplate Context="file">
                <MudTd>@file.Name</MudTd>
                <MudTd>@file.Path</MudTd>
                <MudTd>@file.Size</MudTd>
                <MudTd>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="() => ShowPreview(file)">
                        Preview
                    </MudButton>
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudTabPanel>

    <!-- File Upload Example -->
    <MudTabPanel Text="File Upload">
        <h4>Upload a File</h4>
        <input type="file" @ref="fileInput" @onchange="HandleFileUpload" />
        <p>@uploadMessage</p>
    </MudTabPanel>

    <!-- Toast Notifications Example -->
    <MudTabPanel Text="Toast Notifications">
        <h4>Toast Notifications</h4>
        <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="ShowSuccessToast">Show Success Toast</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="ShowErrorToast">Show Error Toast</MudButton>
    </MudTabPanel>

    <!-- Persistent Storage Example -->
    <MudTabPanel Text="Local Storage">
        <h4>Persistent State with Local Storage</h4>
        <MudButton Variant="Variant.Filled" OnClick="SaveTheme">Save Dark Theme</MudButton>
        <MudButton Variant="Variant.Filled" OnClick="LoadTheme">Load Theme</MudButton>
        <p>Saved Theme: @savedTheme</p>
    </MudTabPanel>
</MudTabs>

@code {
    private List<FileModel> files = new()
    {
        new FileModel { Name = "Document1.txt", Path = "/docs/Document1.txt", Size = 1024 },
        new FileModel { Name = "Image1.png", Path = "/images/Image1.png", Size = 2048 },
    };

    private ElementReference fileInput;
    private string uploadMessage;
    private string savedTheme;

    private void ShowPreview(FileModel file)
    {
        ToastService.ShowInfo($"Preview for {file.Name}");
    }

    private async Task HandleFileUpload(ChangeEventArgs e)
    {
        var fileReference = (await FileReaderService.CreateReference(fileInput).EnumerateFilesAsync()).FirstOrDefault();

        if (fileReference != null)
        {
            var fileInfo = await fileReference.ReadFileInfoAsync();
            uploadMessage = $"Uploaded: {fileInfo.Name}, Size: {fileInfo.Size / 1024} KB";
            StateHasChanged();
        }
        else
        {
            uploadMessage = "No file selected.";
        }
    }

    private void ShowSuccessToast() => ToastService.ShowSuccess("File synchronized successfully!");

    private void ShowErrorToast() => ToastService.ShowError("An error occurred during synchronization.");

    private async Task SaveTheme()
    {
        await LocalStorageService.SetItemAsync("theme", "dark");
        savedTheme = "dark";
        ToastService.ShowInfo("Theme saved!");
    }

    private async Task LoadTheme()
    {
        savedTheme = await LocalStorageService.GetItemAsync<string>("theme") ?? "not set";
        ToastService.ShowInfo($"Loaded theme: {savedTheme}");
    }

    public class FileModel
    {
        public string Name { get; set; }
        public string Path { get; set; }
        public int Size { get; set; }
    }
}
